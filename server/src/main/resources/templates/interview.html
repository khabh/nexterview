<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Create Interview</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&family=Young+Serif&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="/css/fa.min.css">
    <link rel="stylesheet" href="/css/interview.css">
    <script>
        let prompts = [];
        let dialogues = [];

        document.addEventListener("DOMContentLoaded", function () {
            fetchPrompts();
        });

        async function fetchPrompts() {
            if (prompts.length === 0) {
                const response = await fetch("/api/prompts");
                prompts = await response.json();
            }

            const categorySelect = document.getElementById("prompt");
            categorySelect.innerHTML = "";

            prompts.forEach(prompt => {
                const option = document.createElement("option");
                option.value = prompt.id;
                option.textContent = prompt.topic;
                categorySelect.appendChild(option);
            });

            if (prompts.length > 0) {
                fetchQueries(prompts[0].id);
            }
        }

        function fetchQueries(promptId) {
            const selectedPrompt = prompts.find(prompt => prompt.id === parseInt(promptId));
            const queries = selectedPrompt ? selectedPrompt.queries : [];

            const queryContainer = document.getElementById("query-section");
            queryContainer.innerHTML = "";

            queries.forEach(query => {
                const div = document.createElement("div");
                div.classList.add("dynamic-input");

                const label = document.createElement("label");
                label.textContent = query.query;

                const textarea = document.createElement("textarea");
                textarea.name = `answer-${query.id}`;
                textarea.id = `answer-${query.id}`;
                textarea.rows = 3;

                div.appendChild(label);
                div.appendChild(textarea);
                queryContainer.appendChild(div);
            });
        }

        async function generateDialogues(event) {
            event.preventDefault();

            const promptId = document.getElementById("prompt").value;
            const inputs = document.querySelectorAll(".dynamic-input textarea");

            const promptAnswers = Array.from(inputs).map(input => ({
                promptQueryId: input.id.split("-")[1],
                answer: input.value
            }));

            const requestData = {promptAnswers};

            const response = await fetch(`/api/prompts/${promptId}/dialogues`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(requestData)
            });

            const newDialogues = await response.json();
            newDialogues.forEach(dialogue => {
                const div = createDialogueElement(dialogue);
                document.getElementById("dialogues").appendChild(div);
            });

            dialogues.push(...newDialogues);
        }

        function createDialogueElement(dialogue) {
            const div = document.createElement("div");
            div.classList.add("dialogue-entry");

            const questionText = document.createElement("span");
            questionText.textContent = dialogue.question;
            questionText.classList.add("dialogue-question-text");

            const answerText = document.createElement("span");
            answerText.textContent = dialogue.answer;
            answerText.classList.add("dialogue-answer-text");

            const questionInput = document.createElement("input");
            questionInput.type = "text";
            questionInput.value = dialogue.question;
            questionInput.classList.add("dialogue-question");
            questionInput.style.display = "none";

            const answerInput = document.createElement("textarea");
            answerInput.type = "text";
            answerInput.value = dialogue.answer;
            answerInput.classList.add("dialogue-answer");
            answerInput.style.display = "none";
            answerInput.rows = 3;

            const editButton = document.createElement("button");
            editButton.textContent = "수정";
            editButton.type = "button";
            editButton.onclick = () => toggleEditMode(div, true);

            const completeButton = document.createElement("button");
            completeButton.textContent = "완료";
            completeButton.type = "button";
            completeButton.style.display = "none";
            completeButton.onclick = () => {
                dialogue.question = questionInput.value;
                dialogue.answer = answerInput.value;
                questionText.textContent = dialogue.question;
                answerText.textContent = dialogue.answer;

                toggleEditMode(div, false);
            };

            const deleteButton = document.createElement("button");
            deleteButton.textContent = "삭제";
            deleteButton.type = "button";
            deleteButton.onclick = () => {
                div.remove();
                dialogues = dialogues.filter(d => d !== dialogue);
            };

            div.appendChild(questionText);
            div.appendChild(questionInput);
            div.appendChild(answerText);
            div.appendChild(answerInput);
            div.appendChild(editButton);
            div.appendChild(completeButton);
            div.appendChild(deleteButton);

            return div;
        }

        function toggleEditMode(div, isEditing) {
            const questionText = div.querySelector(".dialogue-question-text");
            const answerText = div.querySelector(".dialogue-answer-text");
            const questionInput = div.querySelector(".dialogue-question");
            const answerInput = div.querySelector(".dialogue-answer");
            const editButton = div.querySelector("button:nth-child(5)");
            const completeButton = div.querySelector("button:nth-child(6)");

            if (isEditing) {
                questionInput.style.display = "";
                answerInput.style.display = "";
                questionText.style.display = "none";
                answerText.style.display = "none";
                editButton.style.display = "none";
                completeButton.style.display = "";
            } else {
                questionInput.style.display = "none";
                answerInput.style.display = "none";
                questionText.style.display = "";
                answerText.style.display = "";
                editButton.style.display = "";
                completeButton.style.display = "none";
            }
        }

        function addCustomDialogue() {
            const outputDiv = document.getElementById("dialogues");
            const dialogue = {question: "", answer: ""};
            const dialogueDiv = createDialogueElement(dialogue);
            toggleEditMode(dialogueDiv, true);
            outputDiv.appendChild(dialogueDiv);
        }

        async function saveInterview(event) {
            event.preventDefault();

            const promptId = document.getElementById("prompt").value;
            const interviewTitle = document.getElementById("interview-title").value;
            const inputs = document.querySelectorAll(".dynamic-input textarea");

            const updatedDialogues = Array.from(document.querySelectorAll(".dialogue-entry")).map(entry => ({
                question: entry.querySelector(".dialogue-question").value,
                answer: entry.querySelector(".dialogue-answer").value
            }));

            const requestData = {
                title: interviewTitle,
                promptAnswers: Array.from(inputs).map(input => ({
                    promptQueryId: input.id.split("-")[1],
                    answer: input.value
                })),
                dialogues: updatedDialogues
            };

            const response = await fetch(`/api/prompts/${promptId}/interviews`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(requestData)
            });

            const result = await response.json();
            alert(`인터뷰 저장 완료: ${result.title}`);
        }
    </script>
</head>
<body>
<div class="container">
    <form onsubmit="saveInterview(event)">
        <div class="interview-title">
            <label for="interview-title">인터뷰 제목</label>
            <input type="text" id="interview-title" placeholder="인터뷰 제목을 입력해 주세요" required>
        </div>

        <div class="category-selection">
            <label for="prompt">프롬프트 선택</label>
            <select id="prompt" onchange="fetchQueries(this.value)">
                <option value="">프롬프트 선택</option>
            </select>
        </div>


        <div id="input-fields" class="input-fields">
            <div class="query-section-title">프롬프트 질문지</div>
            <div class="query-container">
                <div id="query-section">
                </div>
                <button type="button" class="right-button" onclick="generateDialogues(event)">문답 자동 생성
                </button>
            </div>
        </div>

        <label>질문과 답변</label>
        <div id="output">
            <div id="dialogues">

            </div>
            <button class="add-dialogue-button" type="button" onclick="addCustomDialogue()">
                <i class="fa-solid fa-plus fa-xl"></i>
            </button>

        </div>

        <button type="submit" class="right-button">인터뷰 저장</button>
    </form>
</div>
</body>
</html>
