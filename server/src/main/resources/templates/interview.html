<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Create Interview</title>
    <script>
        let prompts = [];
        let dialogues = [];

        document.addEventListener("DOMContentLoaded", function () {
            fetchPrompts();
        });

        async function fetchPrompts() {
            if (prompts.length === 0) {
                const response = await fetch("/api/prompts");
                prompts = await response.json();
            }

            const categorySelect = document.getElementById("prompt");
            categorySelect.innerHTML = "";

            prompts.forEach(prompt => {
                const option = document.createElement("option");
                option.value = prompt.id;
                option.textContent = prompt.topic;
                categorySelect.appendChild(option);
            });

            if (prompts.length > 0) {
                fetchQueries(prompts[0].id);
            }
        }

        function fetchQueries(promptId) {
            const selectedPrompt = prompts.find(prompt => prompt.id === parseInt(promptId));
            const queries = selectedPrompt ? selectedPrompt.queries : [];

            const inputFields = document.getElementById("input-fields");
            inputFields.innerHTML = "";

            queries.forEach(query => {
                const div = document.createElement("div");
                div.classList.add("dynamic-input");

                const label = document.createElement("label");
                label.textContent = query.query;

                const textarea = document.createElement("textarea");
                textarea.name = `answer-${query.id}`;
                textarea.id = `answer-${query.id}`;
                textarea.rows = 3;

                div.appendChild(label);
                div.appendChild(textarea);
                inputFields.appendChild(div);
            });
        }

        async function generateDialogues(event) {
            event.preventDefault();

            const promptId = document.getElementById("prompt").value;
            const inputs = document.querySelectorAll(".dynamic-input textarea");

            const promptAnswers = Array.from(inputs).map(input => ({
                promptQueryId: input.id.split("-")[1],
                answer: input.value
            }));

            const requestData = {promptAnswers};

            const response = await fetch(`/api/prompts/${promptId}/dialogues`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(requestData)
            });

            dialogues = await response.json();
            displayInterviewDialogues(dialogues);
        }

        function displayInterviewDialogues(dialogues) {
            const outputDiv = document.getElementById("output");
            outputDiv.innerHTML = "<h3>질문 & 답변</h3>";

            dialogues.forEach(dialogue => {
                const questionElement = document.createElement("p");
                questionElement.textContent = dialogue.question;

                const answerElement = document.createElement("p");
                answerElement.textContent = dialogue.answer;

                outputDiv.appendChild(questionElement);
                outputDiv.appendChild(answerElement);
            });
        }

        async function saveInterview(event) {
            event.preventDefault();

            const promptId = document.getElementById("prompt").value;
            const interviewTitle = document.getElementById("interview-title").value;
            const inputs = document.querySelectorAll(".dynamic-input textarea");

            const requestData = {
                title: interviewTitle,
                promptAnswers: Array.from(inputs).map(input => ({
                    promptQueryId: input.id.split("-")[1],
                    answer: input.value
                })),
                dialogues: dialogues.map(dialogue => ({
                    question: dialogue.question,
                    answer: dialogue.answer
                }))
            };

            const response = await fetch(`/api/prompts/${promptId}/interviews`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(requestData)
            });

            const result = await response.json();
            alert(`인터뷰 저장 완료: ${result.title}`);
        }
    </script>
</head>
<body>
<div class="container">
    <form onsubmit="saveInterview(event)">
        <div class="interview-title">
            <label for="interview-title">인터뷰 제목:</label>
            <input type="text" id="interview-title" placeholder="인터뷰 제목을 입력하세요" required>
        </div>

        <div class="category-selection">
            <label for="prompt">프롬프트 선택:</label>
            <select id="prompt" onchange="fetchQueries(this.value)">
                <option value="">프롬프트 선택</option>
            </select>
        </div>

        <div id="input-fields" class="input-fields"></div>
        <button type="button" class="submit-btn" onclick="generateDialogues(event)">면접 질문 생성</button>
        <div id="output"></div>
        <button type="submit" class="save-btn">인터뷰 저장</button>
    </form>
</div>
</body>
</html>
